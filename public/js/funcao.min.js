$(document).ready((function(){$.ajaxSetup({headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")}});var Toast=Swal.mixin({toast:!0,position:"center",showConfirmButton:!1,timer:4e3});function buscaNotas(){$(".carregando").html('<div style="width: 1.5rem; height: 1.5rem;" class="spinner-border" role="status"><span class="sr-only">Loading...</span></div>'),$(".btnBuscaNotas").prop("disabled",!0);var datas={company:"",start_end_date:"",document_template:"",issuer:"",doc_key:"",issuer_cnpj:""};$(".buscaNotas").each((function(){datas[$(this).attr("name")]=$(this).val()})),$.ajax({url:"buscaNotas",type:"POST",data:datas,success:data=>{console.log(data),$("#div_table_notas").removeClass("d-none"),$("#table_notas").dataTable().fnClearTable(),$("#table_notas").dataTable().fnDestroy(),$("#table_notas").DataTable({responsive:!0,lengthChange:!1,autoWidth:!1,order:[[6,"desc"]],buttons:["copy","csv","colvis"],data:data,columns:[{data:"doc_key"},{data:"button"},{data:"document_template"},{data:"grade_series"},{data:"note_number"},{data:"amount"},{data:"issue_date"},{data:"issuer_cnpj"},{data:"issuer_name"},{data:"issuer_state"},{data:"recipient_cnpj"},{data:"recipient_name"},{data:"recipient_state"}]}).buttons().container().appendTo("#table_notas_wrapper .col-md-6:eq(0)"),$(".carregando").empty(),$(".btnBuscaNotas").prop("disabled",!1)}})}$('[name="cnpj"]').mask("00.000.000/0000-00"),$('[name="post_code"]').mask("00000-000"),$('[name="phone1"]').mask("(00) 0000-0000"),$('[name="phone2"]').mask("(00) 00000-0000"),$(".select2").select2(),$(".date-mask").daterangepicker({singleDatePicker:!1,showDropdowns:!0,locale:{format:"DD/MM/YYYY",daysOfWeek:["dom","seg","ter","qua","qui","sex","sab"],monthNames:["Janeiro","Fevereiro","Março","Abril","Maio","Junho","Julho","Agosto","Setembro","outubro","Novembro","Dezembro"],applyLabel:"Aplicar",cancelLabel:"Cancelar"}}),$((function(){$('[name="state"]')&&$.ajax({url:"https://servicodados.ibge.gov.br/api/v1/localidades/estados/",type:"GET",success:data=>{for(var i=0;data.length>i;i++)$('[name="state"]').append('<option value="'+data[i].sigla+'" data-sigla_id="'+data[i].id+'">'+data[i].sigla+" - "+data[i].nome+"</option>")}})})),$(document).on("change",'[name="state"]',(function(){let sigla_id=$(this).find(":selected").data("sigla_id"),select=$(this).parent().parent().find('select[name="city"]');$.ajax({url:"https://servicodados.ibge.gov.br/api/v1/localidades/estados/"+sigla_id+"/municipios",type:"GET",success:data=>{select.empty(),select.append('<option value="">::Selecione uma Opção::</option>'),select.is(".entrega")&&select.append('<option value="Toda Região">Toda Região</option>');for(var i=0;data.length>i;i++)select.append('<option value="'+data[i].nome+'">'+data[i].nome+"</option>")}})})),$('[name="post_code"]').on("keyup blur",(function(){$(this).parent().parent().find("input, select").attr("readonly",!1),$(this).parent().parent().find("input, select").trigger("change"),9==$(this).val().length&&($(".loadCep").removeClass("d-none"),$.ajax({url:"/cep/"+$(this).val(),type:"GET",success:data=>{$('[name="address"]').val(data.logradouro),data.logradouro&&$('[name="address"]').prop("readonly",!0),$('[name="address2"]').val(data.bairro),data.bairro&&$('[name="address2"]').prop("readonly",!0),$('[name="state"]').val(data.uf),data.uf&&($('[name="state"]').attr("readonly",!0),$('[name="state"]').trigger("change")),setTimeout(()=>{$('[name="city"]').val(data.localidade),data.localidade&&($('[name="city"]').attr("readonly",!0),$('[name="city"]').trigger("change"))},800),$('[name="number"]').focus(),$(".loadCep").addClass("d-none")}}))})),$(document).ready((function(){var user_name=$("#user_name").text(),intials=(user_name=user_name.split(" "))[0].charAt(0)+user_name[user_name.length-1].charAt(0);$("#image_perfil").text(intials.toUpperCase())})),$(document).on("change",".buscaNotas",(function(){"true"==$(this).attr("data-autoBusca")&&(buscaNotas(),$("#notasRefresh").removeClass("d-none"))})),$(document).on("click",".btnBuscaNotas",(function(){buscaNotas()})),$("#notasRefresh").on("click",(function(){var company_id=$('[name="company"]').val(),user_id=$("#user_id").val();""!==company_id&&(Swal.fire({title:"Baixando NFES",html:"Aguarde enquanto as notas estão sendo baixadas.",allowOutsideClick:!1,timerProgressBar:!0,didOpen:()=>{Swal.showLoading()}}),$.ajax({url:"/downloadNFE/"+company_id+"/"+user_id,type:"GET",success:data=>{Swal.fire({icon:"success",title:"NFES Baixados",timer:3e3}),setTimeout(()=>{Swal.fire({title:"Baixando CTES",html:"Aguarde enquanto as notas estão sendo baixadas.",allowOutsideClick:!1,timerProgressBar:!0,didOpen:()=>{Swal.showLoading()}}),$.ajax({url:"/downloadCTE/"+company_id+"/"+user_id,type:"GET",success:data=>{Swal.fire({icon:"success",title:"CTES Baixados",timer:3e3}),$(".buscaNotas").trigger("change")},error:err=>{}})},3e3)},error:err=>{}}))})),$(document).on("click",".btn-salvar",(function(){let save_target=$(this).data("save_target"),save_route=$(this).data("save_route"),update_table=$(this).data("update_table"),table_trash=$(this).data("trash");$(save_target).find("input").removeClass("is-invalid"),$(save_target).find(".invalid-feedback").remove();let modal=$(save_target).parent();modal.is(".modal-content")&&modal.append('<div class="overlay d-flex justify-content-center align-items-center"><i class="fas fa-2x fa-sync fa-spin"></i></div>'),$.ajax({url:save_route,type:"POST",data:new FormData($(save_target)[0]),cache:!1,contentType:!1,processData:!1,success:data=>{$(modal).find(".overlay").remove(),$(modal).parent().parent().modal("hide"),$(save_target).find('input[type="text"]').val(""),$(save_target).find("input, select").attr("readonly",!1),"S"==update_table&&data.table&&$("table tbody").append(data.table),"S"==update_table&&data.tb_up&&$("table tbody").find(".tr-id-"+data.tb_id).html(data.tb_up),"S"==table_trash?(data.tb_trash&&$("table tbody").find(".tr-id-"+data.tb_trash).remove(),Toast.fire({icon:"success",title:"Os dados foram excluidos com successo!"})):Toast.fire({icon:"success",title:"Os dados foram salvos com successo!"})},error:err=>{$(modal).find(".overlay").remove();let erro_tags=err.responseJSON.errors;$.each(erro_tags,(key,value)=>{let tag=$(save_target).find('[name="'+key+'"]');tag.addClass("is-invalid"),tag.parent().append('<div class="invalid-feedback">'+value[0]+"</div>")}),err.responseJSON.msg_alert&&Swal.fire({icon:err.responseJSON.icon_alert,text:err.responseJSON.msg_alert})}})})),$(document).on("click",".btn-editar",(function(){var target=$(this).data("target"),dados=$(this).data("dados"),data="";$.each(dados,(key,value)=>{"file"!==$(target).find('[name="'+key+'"').attr("type")&&"password"!==$(target).find('[name="'+key+'"').attr("type")&&($(target).find('[name="'+key+'"').val(value),$(target).find("."+key).val(value),$(target).find("._"+key).text(value))}),$(target).find('[name="post_code"]').trigger("keyup")})),$(document).on("click",".btn-modal-info",(function(){$("#dadosNotas").modal("show");var id=$(this).data("id"),company_id=$('[name="company"]').val(),route=$(this).data("route");$(".ver-notas").html('<div class="spinner-border" role="status"><span class="sr-only">Loading...</span></div>'),$.ajax({url:route,type:"POST",data:{id:id,company_id:company_id},success:data=>{console.log(data),$(".ver-notas").empty(),data.cnpj==data.dados.issuer_cnpj?$(".btn-valida-nfe").addClass("d-none"):$(".btn-valida-nfe").removeClass("d-none"),$.each(data.dados.doc_xmls,(key,value)=>{"57"==value.document_template?$(".btn-valida-nfe").addClass("d-none"):$(".btn-valida-nfe").removeClass("d-none"),$(".ver-notas").append('<div class="row border rounded py-3 px-2"><div class="col-6 col-md-4 py-2 px-1">Chave Documento: '+value.doc_key+'</div><div class="col-6 col-md-4 py-2 px-1">NSU: '+value.nsu+'</div><div class="col-6 col-md-4 py-2 px-1">Tipo de Evento: '+value.event_type+'</div><div class="col-6 col-md-4 py-2 px-1">Descrição do Evento: '+value.event_description+'</div><div class="col-6 col-md-4 py-2 px-1">Tipo de Documento: '+value.document_template+'</div><div class="col-6 col-md-4 py-2 px-1"><a target="_blank" href="/baixar-xml/'+value.id+'" class="btn btn-primary">Baixar XML</a></div></div>')})}})}))}));